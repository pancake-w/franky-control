# é«˜é¢‘æ•°æ®é‡‡é›†è§£å†³æ–¹æ¡ˆè®°å½•

## é—®é¢˜èƒŒæ™¯

åœ¨ä½¿ç”¨ Franka Panda æœºæ¢°è‡‚è¿›è¡Œæ•°æ®é‡‡é›†æ—¶ï¼Œéœ€è¦å®ç°ç¨³å®šçš„ 10Hz æ§åˆ¶é¢‘ç‡ï¼ŒåŒæ—¶é‡‡é›†åŒç›® RealSense ç›¸æœºå›¾åƒã€‚åŸæœ‰çš„å•è¿›ç¨‹æ¶æ„ (`collect_ik.py`) åœ¨åŠ å…¥ç›¸æœºåå‡ºç°ä¸¥é‡çš„æ§åˆ¶ä¸ç¨³å®šé—®é¢˜ã€‚

### åŸå§‹é—®é¢˜è¡¨ç°

```
libfranka: Move command rejected: command_not_possible_rejected!
[ERROR] Robot error: motion_generator_velocity_discontinuity
```

- æ§åˆ¶å¾ªç¯æ—¶é—´ä¸ç¨³å®šï¼šmean=~100ms, **max=85-109ms**
- æœºæ¢°è‡‚é¢‘ç¹è§¦å‘ velocity_discontinuity é”™è¯¯
- æ— æ³•å®Œæˆæ­£å¸¸çš„æ•°æ®é‡‡é›†æµç¨‹

---

## é—®é¢˜è¯Šæ–­

### 1. å®šä½ç“¶é¢ˆ

é€šè¿‡é€æ­¥æ’é™¤æ³•ç¡®å®šé—®é¢˜æ ¹æºï¼š

| æµ‹è¯•åœºæ™¯ | ç»“æœ | ç»“è®º |
|---------|------|------|
| å•è¿›ç¨‹ + æ— ç›¸æœº | âœ… ç¨³å®š 10Hz | åŸºç¡€æ§åˆ¶æ­£å¸¸ |
| å•è¿›ç¨‹ + æœ‰ç›¸æœº | âŒ é¢‘ç¹æŠ¥é”™ | **ç›¸æœºæ˜¯é—®é¢˜æ ¹æº** |
| IK è®¡ç®—æ—¶é—´ | å¹³å‡ 0.7ms | IK ä¸æ˜¯ç“¶é¢ˆ |

### 2. æ ¹æœ¬åŸå› åˆ†æ

1. **ç›¸æœºåŒæ­¥è¯»å–é˜»å¡**
   - `pipe.wait_for_frames()` è°ƒç”¨æœ‰æ—¶éœ€è¦ 60-90ms
   - è¿™å¯¼è‡´æ§åˆ¶å¾ªç¯æ— æ³•ä¿æŒç¨³å®šçš„ 10Hz (100ms) å‘¨æœŸ

2. **franky å®æ—¶æ§åˆ¶çº¿ç¨‹æŠ¢å **
   - franky å†…éƒ¨æœ‰å®æ—¶æ§åˆ¶çº¿ç¨‹
   - å½“ä¸»çº¿ç¨‹è¢«ç›¸æœºé˜»å¡æ—¶ï¼Œæœºå™¨äººæ§åˆ¶å‘½ä»¤ä¸è¿ç»­
   - è§¦å‘ velocity_discontinuity ä¿æŠ¤æœºåˆ¶

3. **å•è¿›ç¨‹æ¶æ„çš„å±€é™æ€§**
   - ç›¸æœºè¯»å–ã€IK è®¡ç®—ã€æœºå™¨äººæ§åˆ¶åœ¨åŒä¸€è¿›ç¨‹
   - ä»»ä½•ç¯èŠ‚çš„å»¶è¿Ÿéƒ½ä¼šå½±å“æ§åˆ¶ç¨³å®šæ€§

---

## è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ¶æ„ï¼šå¤šè¿›ç¨‹åˆ†ç¦»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸»è¿›ç¨‹ (Main Process)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚SpaceMouseâ”‚  â”‚ IK Solverâ”‚  â”‚  Camera  â”‚  â”‚  Data    â”‚ â”‚
â”‚  â”‚  Input   â”‚â†’ â”‚(Pinocchio)â”‚â†’ â”‚ (Async)  â”‚â†’ â”‚ Collectorâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚                                                 â”‚
â”‚        â†“ Queue (target_joints)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ§åˆ¶è¿›ç¨‹ (Control Process)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  robot.move(JointWaypointMotion, asynchronous)   â”‚   â”‚
â”‚  â”‚  + Gripper control                                â”‚   â”‚
â”‚  â”‚  + Error recovery (æ¯ 100 æ¬¡å¾ªç¯æ£€æŸ¥ä¸€æ¬¡)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®æ”¹åŠ¨è¯¦è§£

### ä¸€ã€ä¸»è¦æ”¹åŠ¨ï¼ˆæ ¸å¿ƒçªç ´ï¼‰

#### 1. å¤šè¿›ç¨‹éš”ç¦»æœºå™¨äººæ§åˆ¶ â­â­â­

**æ–‡ä»¶**: `data_collection_highfreq.py`

```python
from multiprocessing import Process, Queue, Value

def robot_control_process(robot_ip, command_queue, state_queue, running, gripper_queue):
    """ç‹¬ç«‹è¿›ç¨‹å¤„ç†æœºå™¨äººæ§åˆ¶"""
    robot = Robot(robot_ip)
    
    while running.value:
        # ä»é˜Ÿåˆ—è·å–å‘½ä»¤
        target_joints = command_queue.get(timeout=0.001)
        
        # æ‰§è¡Œè¿åŠ¨
        motion = JointWaypointMotion(
            [JointWaypoint(target_joints)],
            return_when_finished=False
        )
        robot.move(motion, asynchronous=True)

# ä¸»è¿›ç¨‹ä¸­å¯åŠ¨
self.control_process = Process(target=robot_control_process, args=(...))
self.control_process.start()
```

**æ•ˆæœ**: æœºå™¨äººæ§åˆ¶å®Œå…¨éš”ç¦»ï¼Œä¸å—ç›¸æœº/IK å»¶è¿Ÿå½±å“

#### 2. ç›¸æœºå¼‚æ­¥åŒç¼“å†²è¯»å– â­â­â­

**æ–‡ä»¶**: `realsense_api.py`

```python
class RealsenseAPI:
    def __init__(self, ...):
        # åŒç¼“å†²åŒº
        self._rgb_buffer_0 = np.zeros([num_cams, height, width, 3], dtype=np.uint8)
        self._rgb_buffer_1 = np.zeros([num_cams, height, width, 3], dtype=np.uint8)
        self._active_buffer = 0  # åŸå­åˆ‡æ¢æ ‡å¿—
        
    def _async_capture_loop(self):
        """åå°çº¿ç¨‹æŒç»­æ•è·"""
        while self._async_running:
            framesets = [pipe.wait_for_frames() for pipe in self.pipes]
            
            # å†™å…¥éæ´»è·ƒç¼“å†²åŒº
            reading_buffer = self._active_buffer
            if reading_buffer == 0:
                # ä¸»çº¿ç¨‹è¯» buffer_0ï¼Œåå°å†™ buffer_1
                self._rgb_buffer_1[...] = frame_data
                self._active_buffer = 1  # åŸå­åˆ‡æ¢
            else:
                self._rgb_buffer_0[...] = frame_data
                self._active_buffer = 0
    
    def get_rgb(self):
        """Lock-free è¯»å–ï¼Œçº¦ 0.5-2ms"""
        active = self._active_buffer
        if active == 0:
            return self._rgb_buffer_0.copy()
        else:
            return self._rgb_buffer_1.copy()
```

**æ•ˆæœ**: ç›¸æœºè¯»å–ä» 60-90ms é™ä½åˆ° 0.5-2ms

#### 3. å‡å°‘ `robot.state` è°ƒç”¨é¢‘ç‡ â­â­

**é—®é¢˜**: æ§åˆ¶è¿›ç¨‹ä¸­æ¯æ¬¡å¾ªç¯è°ƒç”¨ `robot.state` å¯¼è‡´é˜Ÿåˆ—å †ç§¯

```python
# ä¿®æ”¹å‰ï¼šæ¯æ¬¡å¾ªç¯éƒ½è°ƒç”¨ï¼ˆé˜»å¡ï¼‰
while running.value:
    robot_state = robot.state  # æ…¢ï¼
    target_joints = command_queue.get(timeout=0.001)
    ...

# ä¿®æ”¹åï¼šæ¯ 100 æ¬¡å¾ªç¯æ£€æŸ¥ä¸€æ¬¡
while running.value:
    loop_count += 1
    
    # å…ˆå¤„ç†å‘½ä»¤
    try:
        target_joints = command_queue.get(timeout=0.001)
        robot.move(motion, asynchronous=True)
    except:
        pass
    
    # å¶å°”æ£€æŸ¥çŠ¶æ€
    if loop_count % 100 == 0:
        robot_state = robot.state
        # é”™è¯¯æ¢å¤é€»è¾‘...
```

**æ•ˆæœ**: é˜Ÿåˆ—ä»"å§‹ç»ˆæ»¡"å˜ä¸º"ä¿æŒåœ¨ 0-1"

---

### äºŒã€æ¬¡è¦æ”¹åŠ¨ï¼ˆåŠŸèƒ½å®Œå–„ï¼‰

#### 1. è¿›ç¨‹å¯åŠ¨é¡ºåº

```python
# å¿…é¡»å…ˆé‡Šæ”¾ä¸»è¿›ç¨‹çš„ robot è¿æ¥
collection.ee_pose_init()  # è·å–åˆå§‹ä½å§¿å del robot
collection.start_control_process()  # ç„¶åå¯åŠ¨æ§åˆ¶è¿›ç¨‹
```

#### 2. å¤¹çˆªåˆå§‹åŒ–è¶…æ—¶

```python
state = self.state_queue.get(timeout=30.0)  # ä» 5s å¢åŠ åˆ° 30s
# å¤¹çˆª homing() å¯èƒ½éœ€è¦ 10-20 ç§’
```

#### 3. å¤¹çˆª API å‚æ•°ä¿®æ­£

```python
# é”™è¯¯ï¼šç¼ºå°‘å¿…éœ€å‚æ•°
gripper.grasp_async(force=50.0, epsilon_inner=0.08, ...)

# æ­£ç¡®ï¼šgrasp_async(width, speed, force)
gripper.grasp_async(width=0.0, speed=0.1, force=50.0)
```

#### 4. æ•°æ®è®°å½•é€‚é…å¤šè¿›ç¨‹

```python
# data_collector_v2.py æ–°å¢æ–¹æ³•
def record_observation_external(self, instruction, ee_position, 
                                 ee_orientation, joints, gripper_width):
    """ä¸ä¾èµ– robot å¯¹è±¡çš„è®°å½•æ–¹å¼"""
    # å› ä¸ºä¸»è¿›ç¨‹æ²¡æœ‰ robot å¯¹è±¡ï¼Œéœ€è¦ä¼ å…¥å¤–éƒ¨çŠ¶æ€
```

---

## æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | å•è¿›ç¨‹+ç›¸æœº | å¤šè¿›ç¨‹+ç›¸æœº |
|------|-------------|-------------|
| å¾ªç¯æ—¶é—´ | mean=~100ms, max=85-109ms | mean=100ms, std=0.5ms |
| ç¨³å®šæ€§ | âŒ velocity_discontinuity é”™è¯¯ | âœ… ç¨³å®šè¿è¡Œ |
| é˜Ÿåˆ—çŠ¶æ€ | å§‹ç»ˆæ»¡ (queue full) | ä¿æŒ 0-1 |
| å®é™…é¢‘ç‡ | ä¸ç¨³å®š | ç¨³å®š 9.99-10.0 Hz |
| IK æˆåŠŸç‡ | 100% | 100% |

---

## ä½¿ç”¨æ–¹æ³•

### è¿è¡Œå‘½ä»¤

```bash
conda activate franky-control

python franky_control/data_collection/data_collection_highfreq.py \
    --task_name my_task \
    --instruction "pick up the red block" \
    --use_cameras \
    --use_gripper \
    --control_frequency 10.0 \
    --min_action_steps 50
```

### å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--task_name` | test | ä»»åŠ¡åç§°ï¼Œç”¨äºä¿å­˜ç›®å½• |
| `--instruction` | test | ä»»åŠ¡æŒ‡ä»¤æè¿° |
| `--use_cameras` | False | å¯ç”¨åŒç›®ç›¸æœº |
| `--use_gripper` | False | å¯ç”¨å¤¹çˆªæ§åˆ¶ |
| `--control_frequency` | 10.0 | æ§åˆ¶é¢‘ç‡ (Hz) |
| `--min_action_steps` | 50 | æœ€å°æ­¥æ•°ï¼ˆå°‘äºæ­¤å€¼ä¸ä¿å­˜ï¼‰ |
| `--use_gpu_ik` | False | ä½¿ç”¨ GPU åŠ é€Ÿ IK |
| `--use_joint_filter` | False | å¯ç”¨å…³èŠ‚ä½é€šæ»¤æ³¢ |

### æ“ä½œè¯´æ˜

1. **å¯åŠ¨å**: æŒ‰ Enter å¼€å§‹é‡‡é›†
2. **SpaceMouse æ§åˆ¶**:
   - æ¨åŠ¨: ç§»åŠ¨æœ«ç«¯æ‰§è¡Œå™¨
   - å·¦é”®: å¤¹å–/é‡Šæ”¾
   - å³é”®: é€€å‡ºå¹¶ä¿å­˜
3. **æ•°æ®ä¿å­˜**: è‡ªåŠ¨ä¿å­˜åˆ° `datasets/{task_name}/episode_X/`

---

## æ–‡ä»¶ç»“æ„

```
franky_control/
â”œâ”€â”€ data_collection/
â”‚   â”œâ”€â”€ data_collection_highfreq.py  # âœ… å¤šè¿›ç¨‹ç‰ˆæœ¬ï¼ˆæ¨èä½¿ç”¨ï¼‰
â”‚   â”œâ”€â”€ collect_ik.py                # å•è¿›ç¨‹ç‰ˆæœ¬ï¼ˆæ— ç›¸æœºæ—¶å¯ç”¨ï¼‰
â”‚   â””â”€â”€ data_collector_v2.py         # æ•°æ®è®°å½•å™¨
â”œâ”€â”€ driver/
â”‚   â”œâ”€â”€ realsense_api.py             # âœ… åŒç¼“å†²ç›¸æœºé©±åŠ¨
â”‚   â””â”€â”€ space_mouse.py               # SpaceMouse é©±åŠ¨
â””â”€â”€ kinematics/
    â””â”€â”€ panda_ik_solver.py           # Pinocchio IK æ±‚è§£å™¨
```

---

## æ€»ç»“

### æˆåŠŸçš„ä¸‰å¤§æ”¯æŸ±

1. ğŸ”€ **å¤šè¿›ç¨‹éš”ç¦»** - æœºå™¨äººæ§åˆ¶ä¸å—ç›¸æœº/IK å½±å“
2. ğŸ“· **ç›¸æœºåŒç¼“å†²** - è¯»å–ä» 60-90ms é™åˆ° 0.5-2ms
3. ğŸ”„ **å‡å°‘é˜»å¡è°ƒç”¨** - `robot.state` ä¸å†æ¯å¸§è°ƒç”¨

### ç»éªŒæ•™è®­

1. **å®æ—¶æ§åˆ¶ç³»ç»Ÿä¸­ï¼Œä»»ä½•é˜»å¡è°ƒç”¨éƒ½æ˜¯æ½œåœ¨é£é™©**
2. **å¤šè¿›ç¨‹æ¶æ„å¯ä»¥æœ‰æ•ˆéš”ç¦»ä¸åŒæ—¶é—´å°ºåº¦çš„æ“ä½œ**
3. **åŒç¼“å†²æ˜¯è§£å†³ç”Ÿäº§è€…-æ¶ˆè´¹è€…é€Ÿåº¦ä¸åŒ¹é…çš„ç»å…¸æ–¹æ¡ˆ**
4. **è°ƒè¯•æ—¶é€æ­¥æ’é™¤æ³•éå¸¸æœ‰æ•ˆ** - å…ˆå»æ‰ç›¸æœºéªŒè¯åŸºç¡€åŠŸèƒ½

---

## é™„å½•ï¼šè°ƒè¯•è¿‡ç¨‹ä¸­æ’é™¤çš„é”™è¯¯æ–¹å‘

| å°è¯• | ç»“æœ | è¯´æ˜ |
|------|------|------|
| é™ä½æ§åˆ¶é¢‘ç‡åˆ° 10Hz | âŒ | ä¸è§£å†³æ ¹æœ¬é—®é¢˜ |
| å•è¿›ç¨‹ + IKä¼˜åŒ– | âŒ | IK åªéœ€ 0.7msï¼Œä¸æ˜¯ç“¶é¢ˆ |
| å•è¿›ç¨‹å»æ‰ç›¸æœº | âœ… | è¯æ˜ç›¸æœºæ˜¯é—®é¢˜ |
| å¢åŠ  Joint Filter å¹³æ»‘ | âšª | å¯é€‰ï¼Œéå¿…éœ€ |

---

*æ–‡æ¡£æ›´æ–°æ—¥æœŸ: 2024-12-05*
